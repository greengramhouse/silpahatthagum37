<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบประเมินศิลปหัตถกรรมนักเรียน</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Font: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #fcfbf9;
            overscroll-behavior-y: none;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .gradient-header {
            background: linear-gradient(135deg, #ea580c 0%, #d97706 100%);
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(254, 215, 170, 0.4);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.05);
        }

        .timeline-line {
            position: absolute;
            left: 19px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background: #fed7aa;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 250, 245, 0.95);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(234, 88, 12, 0.1);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.03);
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #ea580c;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: #ea580c;
            border-radius: 0 0 4px 4px;
        }
    </style>
</head>

<body class="min-h-screen text-stone-800 antialiased pb-24">

    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-orange-100 border-dashed rounded-full animate-spin"></div>
            <div
                class="absolute top-0 left-0 w-16 h-16 border-4 border-orange-500 border-solid rounded-full animate-spin border-t-transparent">
            </div>
        </div>
        <p class="mt-4 text-orange-800 font-medium animate-pulse">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div
        class="max-w-md mx-auto min-h-screen md:max-w-5xl md:my-5 md:rounded-[32px] md:shadow-2xl md:bg-white md:overflow-hidden flex flex-col relative">

        <!-- Header -->
        <header class="gradient-header text-white px-6 pt-10 pb-12 shadow-lg relative shrink-0 z-10">
            <div
                class="absolute top-0 right-0 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/4">
            </div>
            <div
                class="absolute bottom-0 left-0 w-24 h-24 bg-orange-300 opacity-20 rounded-full blur-xl translate-y-1/2 -translate-x-1/4">
            </div>

            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <div
                            class="inline-flex items-center gap-1.5 mb-2 bg-white/20 px-2.5 py-0.5 rounded-full text-[10px] font-medium border border-white/20 backdrop-blur-sm">
                            <i class="fas fa-star text-yellow-200"></i>
                            <span>ระดับกลุ่มโรงเรียน สหวิทยศึกษาสุวรรณโยธิน</span>
                        </div>
                        <h1 class="text-xl md:text-2xl font-bold tracking-tight mb-1 text-white drop-shadow-sm">
                            ศิลปหัตถกรรมนักเรียน ครั้งที่ 73</h1>
                        <p class="text-orange-50 text-xs font-light opacity-90">แบบประเมินความพึงพอใจการจัดการแข่งขัน
                        </p>
                    </div>

                    <!-- Guest Badge -->
                    <div
                        class="flex items-center justify-center bg-white/10 w-10 h-10 rounded-full border border-white/20 backdrop-blur-md shadow-sm">
                        <div
                            class="w-14 h-14 mx-auto mb-3 bg-white rounded-full flex items-center justify-center shadow-sm border-2 border-orange-100 overflow-hidden relative">
                            <!-- Placeholder Image (School Icon) -->
                            <!-- <i class="fas fa-school text-2xl text-orange-300"></i> -->
                            <!--  หากต้องการใส่รูปภาพ ให้ใช้แท็กนี้แทน:  -->
                            <img src="https://www.kruchiangrai.net/wp-content/uploads/2019/04/%E0%B8%95%E0%B8%A3%E0%B8%B2%E0%B8%AA%E0%B8%9E%E0%B8%90-716x1024.jpg"
                                class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <main class="flex-grow relative z-20 px-4 -mt-6">

            <!-- PAGE: DASHBOARD -->
            <div id="pageDashboard" class="space-y-4">

                <!-- Schedule Section -->
                <div class="glass-card rounded-2xl overflow-hidden bg-white">
                    <div class="p-4 border-b border-orange-50 flex justify-between items-center bg-orange-50/50">
                        <h3 class="font-bold text-stone-700 text-sm flex items-center gap-2">
                            <div
                                class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs">
                                <i class="far fa-calendar-alt"></i>
                            </div>
                            กำหนดการวันนี้
                        </h3>
                        <span
                            class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-md border border-orange-100">Live</span>
                    </div>

                    <div class="p-5 relative">
                        <div class="timeline-line"></div>
                        <div class="space-y-6 pl-8">
                            <!-- Item 1 -->
                            <div class="relative">
                                <div
                                    class="absolute -left-[39px] top-1 w-4 h-4 rounded-full border-2 border-white bg-green-500 shadow z-10">
                                </div>
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-xs font-bold text-green-600">07:30 - 08:30</span>
                                    <h4 class="text-sm font-semibold text-stone-800">พร้อมกัน ณ โรงเรียนชุมชนวัดไทยงาม
                                    </h4>
                                    <p class="text-[10px] text-stone-400">คณะกรรมการ ผู้บริหาร ครู นักเรียน
                                        และแขกผู้มีเกียรติ</p>
                                </div>
                            </div>
                            <!-- Item 2 -->
                            <div class="relative">
                                <div
                                    class="absolute -left-[39px] top-1 w-4 h-4 rounded-full border-2 border-white bg-blue-500 shadow z-10">
                                </div>
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-xs font-bold text-blue-600">08:30 - 08:40</span>
                                    <h4 class="text-sm font-semibold text-stone-800">ประธานในพิธีเดินทางมาถึง</h4>
                                    <p class="text-[10px] text-stone-400">ผอ. สพป. สระบุรี เขต 2 และคณะ</p>
                                </div>
                            </div>
                            <!-- Item 3 -->
                            <div class="relative">
                                <div
                                    class="absolute -left-[39px] top-1 w-4 h-4 rounded-full border-2 border-white bg-indigo-500 shadow z-10">
                                </div>
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-xs font-bold text-indigo-600">08:45 - 09:00</span>
                                    <h4 class="text-sm font-semibold text-stone-800">พิธีเปิดและกล่าวรายงาน</h4>
                                    <p class="text-[10px] text-stone-400">ประธานกลุ่มโรงเรียนสุวรรณโยธิน กล่าวรายงาน</p>
                                </div>
                            </div>
                            <!-- Item 4 -->
                            <div class="relative">
                                <div
                                    class="absolute -left-[39px] top-1 w-4 h-4 rounded-full border-2 border-white bg-orange-500 shadow z-10">
                                </div>
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-xs font-bold text-orange-600">09:00 เป็นต้นไป</span>
                                    <h4 class="text-sm font-semibold text-stone-800">เริ่มการแข่งขันและเยี่ยมชมกิจกรรม
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="grid grid-cols-2 gap-3">
                    <div
                        class="glass-card rounded-2xl p-4 flex flex-col items-center justify-center text-center bg-white">
                        <i class="fas fa-users text-2xl text-orange-500 mb-2 opacity-80"></i>
                        <span class="text-[10px] text-stone-400 uppercase tracking-wide">ผู้ประเมิน</span>
                        <div class="flex items-baseline gap-1 mt-1">
                            <span id="totalResponses" class="text-3xl font-bold text-stone-700">0</span>
                            <span class="text-xs text-stone-400">คน</span>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-4 flex flex-col items-center justify-center text-center bg-white cursor-pointer hover:bg-orange-50 transition-colors"
                        onclick="goToEvaluation()">
                        <div
                            class="w-10 h-10 rounded-full bg-gradient-to-tr from-orange-500 to-amber-400 flex items-center justify-center text-white shadow-lg shadow-orange-500/30 mb-2 animate-bounce">
                            <i class="fas fa-pen"></i>
                        </div>
                        <span class="text-xs font-bold text-stone-600">ทำแบบประเมิน</span>
                        <span class="text-[9px] text-orange-500 mt-0.5">คลิกเลย!</span>
                    </div>
                </div>

                <!-- NEW: Criteria Link Button -->
                <!-- คุณสามารถเปลี่ยน href="#" เป็นลิงค์เอกสารจริง เช่น Google Drive Link -->
                <a href="https://drive.google.com/drive/folders/12OYLNjtJl8VQtN4m1HW09WNFUxJcDnYg?fbclid=IwdGRjcAOTsaljbGNrA5OxX2V4dG4DYWVtAjExAHNydGMGYXBwX2lkDDM1MDY4NTUzMTcyOAABHrj_PWWpviNRw-u4HdkOwiSSkHK2f1gOHmqr75331MccIGlOHcDMyXi1cGtj_aem_81zleOE-qDe7ZeEChKOgkw"
                    target="_blank"
                    class="block glass-card rounded-2xl p-4 flex items-center justify-between text-stone-700 hover:bg-orange-50 transition-colors group no-underline relative overflow-hidden">
                    <div
                        class="absolute right-0 top-0 w-16 h-16 bg-orange-100 rounded-full blur-xl opacity-50 -mr-4 -mt-4">
                    </div>
                    <div class="flex items-center gap-3 relative z-10">
                        <div
                            class="w-10 h-10 rounded-full bg-white border border-orange-100 text-orange-500 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="text-sm font-bold text-stone-700">เกณฑ์การแข่งขัน</h4>
                            <p class="text-[10px] text-orange-500 font-medium">แตะเพื่ออ่านรายละเอียด</p>
                        </div>
                    </div>
                    <div
                        class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-300 group-hover:bg-white group-hover:text-orange-500 transition-colors">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </a>
                <a href="https://greengramhouse.github.io/silpahatthagum37/plan"
                    target="_blank"
                    class="block glass-card rounded-2xl p-4 flex items-center justify-between text-stone-700 hover:bg-orange-50 transition-colors group no-underline relative overflow-hidden">
                    <div
                        class="absolute right-0 top-0 w-16 h-16 bg-orange-100 rounded-full blur-xl opacity-50 -mr-4 -mt-4">
                    </div>
                    <div class="flex items-center gap-3 relative z-10">
                        <div
                            class="w-10 h-10 rounded-full bg-white border border-orange-100 text-orange-500 flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="text-sm font-bold text-stone-700"><i class="fas fa-map-marked-alt text-white text-sm group-hover:scale-110 transition-transform"></i> ดูสถานที่แข่งขันที่นี่ !</h4>
                            <p class="text-[10px] text-orange-500 font-medium">แตะเพื่ออ่านรายละเอียด</p>
                        </div>
                    </div>
                    <div
                        class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-300 group-hover:bg-white group-hover:text-orange-500 transition-colors">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </div>
                </a>

                <!-- Chart Section -->
                <div class="glass-card rounded-2xl p-5 bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-stone-700 text-sm">ภาพรวมความพึงพอใจ</h3>
                        <div class="flex items-center gap-1 text-[10px] text-stone-400">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            Real-time
                        </div>
                    </div>

                    <div class="flex items-center justify-center relative h-48">
                        <canvas id="satisfactionChart"></canvas>
                        <div
                            class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none pt-4">
                            <span class="text-[10px] text-stone-400 uppercase">เฉลี่ย</span>
                            <span id="avgScore" class="text-3xl font-bold text-stone-700 leading-none">--</span>
                            <div class="flex text-yellow-400 text-[10px] mt-1 gap-0.5">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Organizer Footer -->
                <div class="mt-8 text-center pb-24 opacity-90">
                    <div
                        class="w-16 h-16 mx-auto mb-3 bg-white rounded-full flex items-center justify-center shadow-sm border-2 border-orange-100 overflow-hidden relative">
                        <!-- Placeholder Image (School Icon) -->
                        <!-- <i class="fas fa-school text-2xl text-orange-300"></i> -->
                        <!--  หากต้องการใส่รูปภาพ ให้ใช้แท็กนี้แทน:  -->
                        <img src="https://res.cloudinary.com/gukkghu/image/upload/v1646575846/gukkghu/%E0%B8%87%E0%B8%B2%E0%B8%99%E0%B8%AD%E0%B8%AD%E0%B8%81%E0%B9%81%E0%B8%9A%E0%B8%9A%E0%B8%97%E0%B8%B5%E0%B9%88%E0%B9%84%E0%B8%A1%E0%B9%88%E0%B8%A1%E0%B8%B5%E0%B8%8A%E0%B8%B7%E0%B9%88%E0%B8%AD_aytvpq.png"
                            class="w-full h-full object-cover">
                    </div>
                    <p class="text-[11px] text-stone-500 font-semibold">จัดทำโดย งานธุรการโรงเรียนชุมชนวัดไทยงาม</p>
                    <div class="flex items-center justify-center gap-1 mt-1">
                        <span class="w-1 h-1 rounded-full bg-orange-300"></span>
                        <p class="text-[10px] text-stone-400">ประจำปีการศึกษา 2569</p>
                        <span class="w-1 h-1 rounded-full bg-orange-300"></span>
                    </div>
                </div>

            </div>

            <!-- PAGE: EVALUATION FORM -->
            <div id="pageForm" class="hidden pb-8">
                <div class="glass-card rounded-2xl p-5 bg-white min-h-[500px]">
                    <div class="flex items-center gap-3 mb-6 border-b border-orange-50 pb-4">
                        <div
                            class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600 shadow-sm border border-orange-100">
                            <i class="fas fa-list-check"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-stone-700">แบบประเมิน</h3>
                            <p class="text-xs text-stone-400">ข้อมูลของท่านเป็นประโยชน์ต่อการพัฒนา</p>
                        </div>
                    </div>

                    <form id="evalForm" class="space-y-6">
                        <div id="questionsContainer" class="space-y-8"></div>

                        <button type="submit"
                            class="w-full py-3.5 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-xl font-bold shadow-lg shadow-orange-500/30 active:scale-95 transition-transform flex items-center justify-center gap-2">
                            <i class="fas fa-paper-plane text-sm"></i> ส่งข้อมูล
                        </button>
                    </form>
                </div>
            </div>

        </main>

    </div>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="bottom-nav">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="goToDashboard()" id="nav-dashboard"
                class="nav-item active flex-1 flex flex-col items-center justify-center h-full text-stone-400 hover:text-orange-500">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-[10px] font-medium">หน้าหลัก</span>
            </button>

            <div class="w-px h-8 bg-stone-100"></div>

            <button onclick="goToEvaluation()" id="nav-evaluation"
                class="nav-item flex-1 flex flex-col items-center justify-center h-full text-stone-400 hover:text-orange-500">
                <i class="fas fa-clipboard-list text-lg mb-1"></i>
                <span class="text-[10px] font-medium">ประเมิน</span>
            </button>
        </div>
    </nav>

    <!-- CONFIGURATOR (Hidden) -->
    <input type="hidden" id="apiUrlInput" value="">

    <script type="module">
        // --- 1. CONFIG & SETUP ---
        let APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxT_3DIKFv10M7B_ykw0r0EBKywAUdJ8DNbMd4fon4-87KqY3lmKDvKFe0J4VV788ZB/exec";

        // MOCK DATA (Update to match new structure for offline testing)
        const MOCK_DATA = {
            questions: [
                { id: 1, part: "ตอนที่ 1 ข้อมูลทั่วไป", question: "สถานภาพผู้ตอบแบบประเมิน", type: "choice", options: ["ผู้บริหารสถานศึกษา", "ครู", "บุคลากรทางการศึกษา", "อื่น ๆ (ระบุ)"] },
                { id: 2, part: "ตอนที่ 2 ความพึงพอใจต่อการจัดการแข่งขัน", question: "1. การวางแผนและการเตรียมความพร้อมในการจัดการแข่งขัน", type: "rating" },
                { id: 3, part: "ตอนที่ 2 ความพึงพอใจต่อการจัดการแข่งขัน", question: "2. ความชัดเจนของกำหนดการและการประชาสัมพันธ์", type: "rating" },
                { id: 12, part: "ตอนที่ 3 ความพึงพอใจโดยรวม", question: "11. ท่านมีความพึงพอใจต่อการจัดการแข่งขันงานศิลปหัตถกรรม ครั้งที่ 73 โดยรวม", type: "rating" },
                { id: 13, part: "ตอนที่ 4 ข้อเสนอแนะเพิ่มเติม", question: "12. ข้อเสนอแนะหรือความคิดเห็นเพิ่มเติม", type: "text" }
            ],
            summary: { count: 128, scores: [5, 10, 25, 48, 40] }
        };

        let chartInstance = null;
        let guestId = "";
        let isDataLoaded = false;

        function initGuest() {
            let storedId = localStorage.getItem('eval_guest_id');
            if (!storedId) {
                storedId = 'guest_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('eval_guest_id', storedId);
            }
            guestId = storedId;
        }
        initGuest();

        document.addEventListener('DOMContentLoaded', () => {
            goToDashboard(true);
        });

        // --- 2. NAVIGATION & UI ---
        function updateBottomNav(pageId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-orange-600'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.add('text-stone-400'));

            let activeBtnId = '';
            if (pageId === 'pageDashboard') activeBtnId = 'nav-dashboard';
            if (pageId === 'pageForm') activeBtnId = 'nav-evaluation';

            const activeBtn = document.getElementById(activeBtnId);
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-orange-600');
                activeBtn.classList.remove('text-stone-400');
            }
        }

        window.showPage = (pageId) => {
            ['pageDashboard', 'pageForm'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateBottomNav(pageId);
        }

        window.goToDashboard = async (forceReload = false) => {
            showPage('pageDashboard');
            if (forceReload || !isDataLoaded) {
                await loadDashboardData();
            }
        }

        window.goToEvaluation = async () => {
            showPage('pageForm');
            await renderForm();
        }

        // --- 3. DATA & API ---
        async function fetchAPI(action, payload = null) {
            const inputUrl = document.getElementById('apiUrlInput').value;
            if (inputUrl) APPS_SCRIPT_URL = inputUrl;

            // Mock Check
            if (!APPS_SCRIPT_URL) {
                await new Promise(r => setTimeout(r, 600));
                if (action === "getQuestions") return { status: "success", data: MOCK_DATA.questions };
                if (action === "getSummary") return { status: "success", count: MOCK_DATA.summary.count, scores: MOCK_DATA.summary.scores };
                if (action === "submit") {
                    MOCK_DATA.summary.count++;
                    return { status: "success" };
                }
            }

            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=${action}`, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({ action, ...payload })
                });

                if (action.startsWith('get')) {
                    const url = `${APPS_SCRIPT_URL}?action=${action}`;
                    const res = await fetch(url);
                    return await res.json();
                } else {
                    return { status: "success" };
                }
            } catch (e) {
                console.error("API Error:", e);
                if (action === "getQuestions") return { status: "success", data: MOCK_DATA.questions };
                if (action === "getSummary") return { status: "success", count: MOCK_DATA.summary.count, scores: MOCK_DATA.summary.scores };
                return { status: "error" };
            }
        }

        async function loadDashboardData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            const res = await fetchAPI('getSummary');
            document.getElementById('loadingOverlay').style.display = 'none';

            if (res.status === 'success') {
                isDataLoaded = true;
                animateValue("totalResponses", 0, res.count, 1000);
                renderChart(res.scores);
            }
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function renderChart(scores) {
            const ctx = document.getElementById('satisfactionChart').getContext('2d');
            let totalVote = scores.reduce((a, b) => a + b, 0);
            let totalScore = scores.reduce((sum, count, idx) => sum + (count * (idx + 1)), 0);
            const avg = totalVote ? (totalScore / totalVote).toFixed(1) : "0.0";

            const avgElement = document.getElementById('avgScore');
            if (avgElement) avgElement.innerText = avg;

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['1 ดาว', '2 ดาว', '3 ดาว', '4 ดาว', '5 ดาว'],
                    datasets: [{
                        data: scores,
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false } },
                    layout: { padding: 0 }
                }
            });
        }

        async function renderForm() {
            const container = document.getElementById('questionsContainer');
            if (!container.innerHTML) container.innerHTML = '<div class="text-center py-10 text-stone-400"><i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i><br>กำลังโหลด...</div>';

            const res = await fetchAPI('getQuestions');

            if (res.status === 'success') {
                container.innerHTML = '';

                let currentPart = "";

                res.data.forEach((q, index) => {
                    // Render Part Header if changed
                    if (q.part !== currentPart) {
                        currentPart = q.part;
                        const headerDiv = document.createElement('div');
                        headerDiv.className = "mt-6 mb-3 pt-2 border-t border-dashed border-orange-200 first:border-0 first:pt-0 first:mt-0";
                        headerDiv.innerHTML = `<h4 class="text-sm font-bold text-orange-600 bg-orange-50 inline-block px-3 py-1 rounded-full border border-orange-100">${currentPart}</h4>`;
                        container.appendChild(headerDiv);
                    }

                    const div = document.createElement('div');
                    div.className = "mb-6";

                    if (q.type === 'choice') {
                        div.innerHTML = `
                            <p class="text-sm font-medium text-stone-700 mb-3">${q.question}</p>
                            <div class="space-y-2">
                                ${q.options.map(opt => `
                                    <label class="flex items-center p-3 border border-stone-200 rounded-xl cursor-pointer hover:bg-orange-50 hover:border-orange-200 transition-all bg-white group">
                                        <input type="radio" name="q_${q.id}" value="${opt}" class="w-4 h-4 text-orange-500 border-stone-300 focus:ring-orange-500" required ${opt.includes('ระบุ') ? `onchange="document.getElementById('other_${q.id}').disabled = false; document.getElementById('other_${q.id}').focus()"` : `onchange="document.getElementById('other_${q.id}').disabled = true; document.getElementById('other_${q.id}').value = ''"`}>
                                        <span class="ml-3 text-sm text-stone-600 group-hover:text-orange-700">${opt}</span>
                                        ${opt.includes('ระบุ') ? `<input type="text" id="other_${q.id}" class="ml-2 border-b border-stone-300 focus:border-orange-500 outline-none text-sm text-stone-700 bg-transparent w-full" disabled placeholder="โปรดระบุ..." oninput="this.previousElementSibling.previousElementSibling.value = 'อื่นๆ: ' + this.value">` : ''}
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    } else if (q.type === 'rating') {
                        div.innerHTML = `
                            <p class="text-sm font-medium text-stone-700 mb-2">${q.question}</p>
                            <div class="bg-stone-50 rounded-xl p-3 flex justify-between items-center px-4 relative">
                                <div class="absolute top-1/2 left-6 right-6 h-0.5 bg-stone-200 -z-0"></div>
                                ${[1, 2, 3, 4, 5].map(score => `
                                    <label class="cursor-pointer group flex flex-col items-center relative z-10">
                                        <input type="radio" name="q_${q.id}" value="${score}" class="peer sr-only" required>
                                        <div class="w-9 h-9 rounded-full border border-stone-300 bg-white flex items-center justify-center text-stone-400 font-bold text-sm transition-all duration-200 peer-checked:border-orange-500 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:scale-110 peer-checked:shadow-md">
                                            ${score}
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div class="flex justify-between px-4 text-[10px] text-stone-400 mt-1">
                                <span>${q.part.includes('รวม') ? 'น้อยที่สุด' : 'ปรับปรุง'}</span>
                                <span>${q.part.includes('รวม') ? 'มากที่สุด' : 'ดีเยี่ยม'}</span>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `
                            <p class="text-sm font-medium text-stone-700 mb-2">${q.question}</p>
                            <textarea name="q_${q.id}" rows="3" class="w-full p-3 border border-stone-200 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition bg-white resize-none" placeholder="แสดงความคิดเห็น..."></textarea>
                        `;
                    }
                    container.appendChild(div);
                });
            }
        }

        document.getElementById('evalForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const answers = {};
            for (let [key, value] of formData.entries()) {
                // If value is numeric, convert it. Otherwise keep as string (for choice/text)
                answers[key] = isNaN(value) || value === "" ? value : parseInt(value);
            }

            const payload = {
                user: { uid: guestId, name: "Guest", email: "-" },
                answers: answers
            };

            Swal.fire({
                title: 'กำลังบันทึก...',
                html: 'กรุณารอสักครู่',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false,
                background: 'rgba(255, 255, 255, 0.95)',
                backdrop: `rgba(0,0,0,0.3)`
            });

            const res = await fetchAPI('submit', payload);

            if (res.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'เรียบร้อย!',
                    text: 'ขอบคุณสำหรับความคิดเห็น',
                    confirmButtonText: 'กลับหน้าหลัก',
                    confirmButtonColor: '#ea580c',
                    customClass: { popup: 'rounded-2xl' }
                }).then(() => {
                    goToDashboard(true);
                });
            } else {
                Swal.fire('ผิดพลาด', 'กรุณาลองใหม่อีกครั้ง', 'error');
            }
        });
    </script>
</body>

</html>


